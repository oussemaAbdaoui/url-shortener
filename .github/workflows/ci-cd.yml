name: CI/CD Pipeline for URL Shortener

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: url-shortener
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  # Job 1: Code Quality and Testing
  code-quality:
    name: Code Quality & Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest
      
      - name: Run basic test
        run: |
          python -c "from app import generate_short_code; print('Import successful')"
          python -c "from app import app; print('App imported successfully')"
      
      - name: Check formatting
        run: |
          pip install black
          black --check app.py || echo "Formatting issues found (optional to fix)"
      
      - name: Run linter
        run: |
          pip install flake8
          flake8 app.py --max-line-length=100 || echo "Linting issues found"

  # Job 2: Security Scanning (SAST)
  security-sast:
    name: Security Scanning (SAST)
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload SAST report
        uses: actions/upload-artifact@v4
        with:
          name: sast-report
          path: trivy-results.sarif

  # Job 3: Build and Push Docker Image
  build-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [code-quality, security-sast]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build Docker image
        run: |
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest .
      
      - name: Push Docker image
        run: |
          docker push ${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
      
      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest'
          format: 'table'
          output: 'trivy-image-results.txt'
      
      - name: Upload Docker scan results
        uses: actions/upload-artifact@v4
        with:
          name: docker-scan
          path: trivy-image-results.txt

  # Job 4: Dynamic Security Testing (DAST)
  security-dast:
    name: Dynamic Security Testing (DAST)
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Run the application for testing
        run: |
          docker run -d --name url-shortener-test -p 5001:5000 \
            ${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          sleep 5
      
      - name: Basic API test
        run: |
          curl -f http://localhost:5001/health || exit 1
          echo "âœ… Application is running"
      
      - name: Cleanup
        if: always()
        run: |
          docker stop url-shortener-test || true
          docker rm url-shortener-test || true

  # Job 5: Deploy to Kubernetes
  deploy-kubernetes:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: security-dast
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install minikube and kubectl
        run: |
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          
          # Install minikube
          curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
          sudo install minikube-linux-amd64 /usr/local/bin/minikube
      
      - name: Start minikube cluster
        run: |
          minikube start --driver=docker
      
      - name: Deploy application
        run: |
          # Update image in deployment file
          sed -i "s|your-dockerhub-username|${{ env.DOCKERHUB_USERNAME }}|g" k8s/deployment.yaml
          
          # Apply Kubernetes manifests
          kubectl apply -f k8s/
          
          # Wait for deployment
          kubectl rollout status deployment/url-shortener --timeout=120s
      
      - name: Test the deployment
        run: |
          # Get service URL
          minikube service url-shortener-service --url
          
          # Test health endpoint
          kubectl get pods
          kubectl describe deployment/url-shortener

  # Job 6: Final Summary
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [code-quality, security-sast, build-docker, security-dast, deploy-kubernetes]
    if: always()
    
    steps:
      - name: Display summary
        run: |
          echo "ðŸš€ CI/CD Pipeline Completed Successfully!"
          echo "=========================================="
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "Jobs Status:"
          echo "- Code Quality: ${{ needs.code-quality.result }}"
          echo "- Security SAST: ${{ needs.security-sast.result }}"
          echo "- Docker Build: ${{ needs.build-docker.result }}"
          echo "- Security DAST: ${{ needs.security-dast.result }}"
          echo "- Kubernetes Deploy: ${{ needs.deploy-kubernetes.result }}"
          echo ""
          echo "ðŸ“¦ Docker Image:"
          echo "${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"